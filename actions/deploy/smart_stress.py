import os
import sys

try:
    import pandas as pd
except ImportError:
    pd = None


class StressCompiler:
    """
    å‹æµ‹è„šæœ¬ç¼–è¯‘å™¨ï¼šè´Ÿè´£æŠŠé…ç½®ç¿»è¯‘æˆ Android Shell
    """

    def __init__(self, target_pkg, duration=3600, start_uri=None):
        self.target_pkg = target_pkg
        self.duration = duration
        self.start_uri = start_uri or f"{target_pkg}/.MainActivity"

    def compile(self, task_list):
        """æ ¸å¿ƒç¼–è¯‘é€»è¾‘"""
        # --- Shell å¤´éƒ¨ï¼šç›‘æ§ä¸ä¿æ´» ---
        shell = f"""#!/system/bin/sh
# Auto-generated by Dognoise Compiler
LOG_DIR="/sdcard/dognoise_stress"
mkdir -p $LOG_DIR
EVENT_LOG="$LOG_DIR/event.log"
CRASH_LOG="$LOG_DIR/crash_stack.log"

echo "=== [$(date)] å‹æµ‹å¯åŠ¨: {self.target_pkg} (æ—¶é•¿: {self.duration}s) ===" > $EVENT_LOG

# 1. å¯åŠ¨æ—¥å¿—æŠ“å–
logcat -c
nohup logcat -v time *:E -f $CRASH_LOG -r 10240 -n 5 & 
LOGCAT_PID=$!

start_time=$(date +%s)
loop_count=0

# 2. ä¿æ´»å‡½æ•°
function ensure_app_foreground() {{
    current_focus=$(dumpsys window | grep mCurrentFocus)
    if ! echo "$current_focus" | grep -q "{self.target_pkg}"; then
        echo "[ğŸš¨ RECOVER] $(date) åº”ç”¨ä¸åœ¨å‰å°ï¼Œå°è¯•æ‹‰èµ·..." >> $EVENT_LOG
        am start -n {self.start_uri}
        sleep 8
    fi
}}

# 3. WiFi/è“ç‰™å‡½æ•° (ç•¥ï¼Œä¿æŒç®€æ´ï¼Œéœ€è¦å¯è‡ªè¡Œæ·»åŠ )

# --- ä¸»å¾ªç¯ ---
while [ $(($(date +%s) - start_time)) -lt {self.duration} ]; do

    # æ­»äº¡ç›‘æ§
    if [ -z "$(pidof {self.target_pkg})" ]; then
        echo "[ğŸ’€ DIED] $(date) åº”ç”¨è¿›ç¨‹æ¶ˆå¤±" >> $EVENT_LOG
    fi

"""
        # --- ç¿»è¯‘ä»»åŠ¡ ---
        for task in task_list:
            action = str(task.get('action')).upper().strip()
            indent = "    "

            # åªæœ‰äº¤äº’ç±»æ“ä½œæ‰æ£€æŸ¥å‰å°ï¼Œé˜²æ­¢ç‚¹é”™
            if action in ["CLICK", "SWIPE", "KEY", "TEXT"]:
                shell += f"{indent}ensure_app_foreground\n"

            if action == "CLICK":
                shell += f"{indent}input tap {task.get('p1')} {task.get('p2')}\n"
            elif action == "SWIPE":
                shell += f"{indent}input swipe {task.get('p1')} {task.get('p2')} {task.get('p3')} {task.get('p4')} 300\n"
            elif action == "KEY":
                shell += f"{indent}input keyevent {task.get('p1')}\n"
            elif action == "TEXT":
                txt = str(task.get('p1')).replace(" ", "%s")
                shell += f"{indent}input text '{txt}'\n"
            elif action == "WAIT":
                shell += f"{indent}sleep {task.get('p1')}\n"
            elif action == "STOP":
                shell += f"{indent}am force-stop {self.target_pkg}\n"
            elif action == "START":
                shell += f"{indent}am start -n {self.start_uri}\n"
            elif action == "SHELL":
                shell += f"{indent}{task.get('p1')}\n"

        # --- å°¾éƒ¨ ---
        shell += """
    loop_count=$((loop_count + 1))
    if [ $((loop_count % 10)) -eq 0 ]; then
        echo "[Heartbeat] $(date) è¿è¡Œæ­£å¸¸ (è½®æ¬¡: $loop_count)" >> $EVENT_LOG
    fi
    sleep 1
done

echo "=== [$(date)] å‹æµ‹ç»“æŸ ===" >> $EVENT_LOG
kill $LOGCAT_PID
"""
        return shell

def run(context, **kwargs):
    """
    æ™ºèƒ½å‹æµ‹ V6ï¼šå…¨æŒ‡ä»¤é›† + è“ç‰™/WiFi + ã€åº”ç”¨ä¿æ´»/é˜²è¯¯è§¦ã€‘
    """
    compiler = StressCompiler(
        target_pkg=kwargs.get("package_name"),
        duration=kwargs.get("duration", 3600),
        start_uri=kwargs.get("start_uri")
    )

    task_list = kwargs.get("tasks", [])
    shell_content = compiler.compile(task_list)


    try:
        local_path = os.path.join(context.root_dir, "outputs", "stress_runner_v6.sh")
        with open(local_path, "w", encoding="utf-8", newline='\\n') as f:
            f.write(shell_content)
        # ... Push & Run ...
        return {"status": True, "msg": "V6 è„šæœ¬(å¸¦è‡ªæ„ˆèƒ½åŠ›)å·²éƒ¨ç½²"}
    except Exception as e:
        return {"status": False, "msg": str(e)}


if __name__ == "__main__":
    print("ğŸ¤– Dognoise ç¦»çº¿ç¼–è¯‘å™¨å¯åŠ¨...")

    # 1. é…ç½® (ä¹Ÿå¯ä»¥ä»å‘½ä»¤è¡Œè¯»)
    EXCEL_FILE = "test_plan.xlsx"
    OUTPUT_DIR = "dist_stress"  # è¾“å‡ºç›®å½•

    # é»˜è®¤é…ç½® (é˜²æ­¢ Excel æ²¡å¡«)
    DEFAULT_PKG = "com.huawei.video"
    DEFAULT_DURATION = 86400 * 3  # 3å¤©

    if not os.path.exists(EXCEL_FILE):
        print(f"âŒ æ‰¾ä¸åˆ° {EXCEL_FILE}ï¼Œè¯·å…ˆåˆ›å»º Excel æ¨¡æ¿ï¼")
        sys.exit(1)

    if not pd:
        print("âŒ ç¼ºå°‘ pandas åº“ï¼Œè¯·æ‰§è¡Œ: pip install pandas openpyxl")
        sys.exit(1)

    print(f"ğŸ“„ æ­£åœ¨è¯»å–: {EXCEL_FILE}")
    df = pd.read_excel(EXCEL_FILE)

    # è½¬æ¢ Excel ä¸º Task List
    tasks = []
    # æå–ç¬¬ä¸€è¡Œçš„é…ç½® (å¦‚æœæœ‰çš„è¯ï¼Œæˆ–è€…ç¡¬ç¼–ç )
    # è¿™é‡Œå‡è®¾æ‰€æœ‰åŠ¨ä½œéƒ½é’ˆå¯¹åŒä¸€ä¸ªåŒ…

    for _, row in df.iterrows():
        act = row.get('åŠ¨ä½œç±»å‹ (Action)')
        if pd.isna(act): continue

        tasks.append({
            "action": act,
            "p1": row.get('å‚æ•°1 (P1)'),
            "p2": row.get('å‚æ•°2 (P2)'),
            "p3": row.get('å‚æ•°3 (P3)'),
            "p4": row.get('å‚æ•°4 (P4)'),
        })

    # 2. ç¼–è¯‘
    compiler = StressCompiler(target_pkg=DEFAULT_PKG, duration=DEFAULT_DURATION)
    shell_code = compiler.compile(tasks)

    # 3. ç”Ÿæˆäº¤ä»˜ç‰©
    if not os.path.exists(OUTPUT_DIR):
        os.makedirs(OUTPUT_DIR)

    # æ–‡ä»¶A: æ ¸å¿ƒ Shell è„šæœ¬
    sh_path = os.path.join(OUTPUT_DIR, "stress_core.sh")
    with open(sh_path, "w", encoding="utf-8", newline='\n') as f:
        f.write(shell_code)

    # æ–‡ä»¶B: â€œä¸€é”®å¯åŠ¨å™¨â€ (Windows BAT)
    bat_content = f"""@echo off
echo [Dognoise] æ­£åœ¨è¿æ¥è®¾å¤‡...
adb wait-for-device
echo [Dognoise] è®¾å¤‡å·²è¿æ¥ï¼Œæ­£åœ¨æ³¨å…¥å‹æµ‹è„šæœ¬...

:: æ¨é€è„šæœ¬
adb push stress_core.sh /data/local/tmp/stress_core.sh
adb shell chmod 777 /data/local/tmp/stress_core.sh

:: åå°è¿è¡Œ (nohup)
adb shell "nohup sh /data/local/tmp/stress_core.sh > /dev/null 2>&1 &"

echo.
echo ==========================================
echo  âœ… éƒ¨ç½²æˆåŠŸï¼è„šæœ¬å·²åœ¨åå°è¿è¡Œã€‚
echo  ğŸ‘‰ ç°åœ¨å¯ä»¥æ‹”æ‰æ•°æ®çº¿äº†ã€‚
echo  ğŸ“‹ æ—¥å¿—è·¯å¾„: /sdcard/dognoise_stress/
echo ==========================================
echo.
pause
"""
    bat_path = os.path.join(OUTPUT_DIR, "ä¸€é”®å¼€å§‹å‹æµ‹.bat")
    with open(bat_path, "w", encoding="gbk") as f:  # Windowsç”¨gbké˜²æ­¢ä¹±ç 
        f.write(bat_content)

    print(f"\nâœ¨ ç¼–è¯‘å®Œæˆï¼è¯·å°† [{OUTPUT_DIR}] æ–‡ä»¶å¤¹æ‰“åŒ…å‘ç»™äº§å“ç»ç†ã€‚")
    print(f"   åŒ…å«: stress_core.sh + ä¸€é”®å¼€å§‹å‹æµ‹.bat")